<html>

<div>
Player Index <input type="number" id="player_index" value="0" step="1" min="0" max="3" />
Player Name <input id="player_name" value="" />
<p id="sessionid"></p>
</div>

<canvas id="framebuffer"></canvas>

<style>
div {
    white-space: pre-wrap;
}
</style>

<div>
W to move forward
S to move backward
A to turn left
D to turn right
Q to strafe left
E to strafe right
F to fire
U to use (and respawn)
</div>

<p id="profiling"></p>

<script>
var Game = {
	stopMain: {},
	sessionId: -1,
	globalpop: false,
	startpost: true,
	keys: {},
	frames: {},
	numframes: 0,
	lastTick: 0,
	lastRender: 0,

	maxposttimes: 100,
	posttimes: [100],
	numposttimes: 0,
	postindex: 0,
	postfull: false,
};

function AddPostTime(time) {
	if (!Game.postfull) {
		Game.numposttimes++;
	}
	if (Game.numposttimes == Game.maxposttimes) {
		Game.postfull = true;
	}
	Game.postindex = (Game.postindex + 1) % Game.numposttimes;
	Game.posttimes[Game.postindex] = time;
}

function GetAveragePostTime() {
	var total = 0;
	for (i=0;i<Game.numposttimes;++i) {
		total += Game.posttimes[i];
	}
	return total / Game.numposttimes;
}

// typedef struct
// {
//     char	forwardmove;	// *2048 for move
//     char	sidemove;	// *2048 for move
//     short	angleturn;	// <<16 for angle delta
//     short	consistancy;	// checks for net game
//     byte	chatchar;
//     byte	buttons;
// } ticcmd_t;

function GeneratePostBody() {
	var numevents = Object.keys(Game.keys).length;
	var body = new ArrayBuffer(13 + numevents + 4);
	var view = new DataView(body);
	view.setUint32(0,Game.sessionId);
	view.setUint8(4,Game.globalpop);

	var player_index = document.getElementById("player_index").value;
	view.setUint32(5, player_index);
	view.setUint32(9, numevents);
	var index=0;
	for (var key in Game.keys) {
		view.setUint8(13+index,key);
		index++;
	}
//	var num_requested_frames = GetAveragePostTime() / 50;
	var num_requested_frames = 1; // adaptive frame interpolation isn't helping a lot yet.
	view.setUint32(13+index,num_requested_frames);

	return body;
}

// helper in case we need to download data for inspection
function download(filename, data) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:binary/octet-stream,' + data);
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
}

document.addEventListener('keydown', (event) => {
  Game.keys[event.keyCode] = 1;
}, false);

document.addEventListener('keyup', (event) => {
	delete Game.keys[event.keyCode];
}, false);

function RenderFrame() {
	const rawcanvas = document.getElementById('framebuffer');
	rawcanvas.width = 960;
	rawcanvas.height = 600;
	const ctx = rawcanvas.getContext('2d');

	var imageData = ctx.getImageData(0, 0, 100, 100);
	var data = new Uint8ClampedArray(4 * 320 * 200);

	var palette = new Uint8ClampedArray(256*3);
	for (var i = 0; i < 256 * 3; ++i) {
		palette[i] = Game.frames[0][i];
	}
	//for (var i = 256*3; i < fb.length; i += 4) {
	fb_index = 256*3;
	for (var i = 0; i < data.length; i += 4) {
		data[i] = palette[Game.frames[0][fb_index]*3];
		data[i+1] = palette[Game.frames[0][fb_index]*3+1];
		data[i+2] = palette[Game.frames[0][fb_index]*3+2];
		data[i+3] = 255;
		fb_index++;
	}

	var imageData = new ImageData(data, 320,200);
	tempcanvas = document.createElement('canvas');
	tempcanvas.width=320;
	tempcanvas.height=200;
	var tempctx = tempcanvas.getContext('2d');
	tempctx.putImageData(imageData,0,0);

	ctx.scale(3,3);
	ctx.drawImage(tempcanvas,0,0);
	Game.lastRender = performance.now();
}

function GetFrame() {
	var xhttp = new XMLHttpRequest();
	var startpost = performance.now();
	xhttp.onload = function(oEvent) {
		var posttime = performance.now() - startpost;
		AddPostTime(posttime);
		var arraybuffer = xhttp.response;
		if (arraybuffer) {
			var byteArray = new Uint8Array(arraybuffer);
			var dv = new DataView(arraybuffer);

			let num_frames = dv.getInt32(0, true); // number of frames
			let frame_len = 320*200 + 768;

			for (i=0;i<num_frames;++i) {
				let fb = new Uint8Array(arraybuffer.slice(4+i*frame_len));
				Game.frames[i] = fb;
			}

			Game.numframes = num_frames;

			Game.sessionId = dv.getInt32(4+num_frames*frame_len,true);
			document.getElementById('sessionid').innerHTML = "SessionId: " + Game.sessionId;

			Game.startpost = true;
		}
	};
	xhttp.open("POST", "https://especially-cunning-bat.edgecompute.app/doomframe", true);
	xhttp.responseType = "arraybuffer";
	var body = GeneratePostBody();
    xhttp.send(body);
}

;(function () {
	function main( tFrame ) {
		Game.stopMain = window.requestAnimationFrame( main );
		var delta = tFrame-Game.lastTick;
		Game.lastTick = tFrame;

		if (Game.numframes > 0)
			RenderFrame();

		if (Game.startpost)
		{
			GetFrame();
			Game.startpost = false;
		}
	}

	function get_value_from_cookie(key) {
		var value;
		var row = document.cookie
			.split('; ')
			.find(row => row.startsWith(key));
			if (typeof row != "undefined") {
				value = row.split('=')[1];
			} else {
				value = "";
			}
		return value;
	}

	function update_name_in_session()
	{
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "https://loudly-verified-elephant.edgecompute.app/update_name_in_session", true);
		xhttp.setRequestHeader("sessionid",Game.sessionId);
		xhttp.setRequestHeader("playerid",get_value_from_cookie('playerid'));
		xhttp.setRequestHeader("name",document.getElementById("player_name").value);
		xhttp.send();
	}

	function lobby_heartbeat() {
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "https://loudly-verified-elephant.edgecompute.app/heartbeat", true);
		xhttp.setRequestHeader("sessionid",Game.sessionId);
		xhttp.setRequestHeader("playerid",get_value_from_cookie('playerid'));
		xhttp.send();
	}

	function init_user() {
		var playerid=get_value_from_cookie('playerid');
		var playername = get_value_from_cookie('playername');

		if (playerid == 0) {
			playerid = Math.floor(Math.random() * 100000);
			document.cookie = "playerid="+playerid;
			playername="Player" + playerid;
			document.cookie = "playername="+playername;
		}
		if (playername == "") {
			playername="Player" + playerid;
			document.cookie = "playername="+playername;
		}
		document.getElementById("player_name").value = playername;

		document.getElementById("player_name").onchange = function() {
			document.cookie = "playername="+document.getElementById("player_name").value;
			update_name_in_session();
		}
		setInterval(lobby_heartbeat, 1000 * 30); // 30s interval
	}

	function join_session() {
		var xhttp = new XMLHttpRequest();
		xhttp.onload = function(oEvent) {
			var parts = xhttp.response.split(',');
			Game.sessionId = parts[0];
			document.getElementById('player_index').value = parts[1];
			Game.playerIndex = parts[1];
			Game.lastTick = performance.now();
			main(performance.now());
		};
		xhttp.open("GET", "https://loudly-verified-elephant.edgecompute.app/join_best_session", true);
		xhttp.responseType = "text";
		xhttp.setRequestHeader("id",get_value_from_cookie('playerid'));
		xhttp.setRequestHeader("name",document.getElementById("player_name").value);
		xhttp.send();
	}

	init_user();
	join_session();
})();
</script>
</html>