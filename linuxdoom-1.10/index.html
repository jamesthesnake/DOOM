"<html>\n"
"\n"
"<div>\n"
"DOOM@EDGE\n"
"\n"
"Player Name <input id=\"player_name\" value=\"\" />\n"
"<button onClick=\"showControlsOverlay();\">Show Controls</button>\n"
"</div>\n"
"<!--Player Index <input type=\"number\" id=\"player_index\" value=\"0\" step=\"1\" min=\"0\" max=\"3\" /> -->\n"
"\n"
"<!--\n"
"	Key bindings\n"
"    {\"key_right\",&key_right, 'D'},\n"
"    {\"key_left\",&key_left, 'A'},\n"
"    {\"key_up\",&key_up, 'W'},\n"
"    {\"key_down\",&key_down, 'S'},\n"
"    {\"key_strafeleft\",&key_strafeleft, 'Q'},\n"
"    {\"key_straferight\",&key_straferight, 'E'},\n"
"\n"
"    {\"key_fire\",&key_fire, 'F'},\n"
"    {\"key_use\",&key_use, 'U'},\n"
"    {\"key_strafe\",&key_strafe, KEY_RALT},\n"
"    {\"key_speed\",&key_speed, KEY_RSHIFT},\n"
"-->\n"
"\n"
"<div id=\"overlay\" onclick=\"removeControlsOverlay()\">\n"
"	<div id=\"text\">\n"
"		W to move forward\n"
"		S to move backward\n"
"		A to turn left\n"
"		D to turn right\n"
"		Q to strafe left\n"
"		E to strafe right\n"
"		F to fire\n"
"		U to use (and respawn)\n"
"	</div>\n"
"  </div>\n"
"\n"
"<canvas id=\"framebuffer\"></canvas>\n"
"\n"
"<div>\n"
"<table id=\"sessions_table\"></table>\n"
"</div>\n"
"\n"
"<style>\n"
"div {\n"
"    white-space: pre-wrap;\n"
"}\n"
"\n"
"table {\n"
"  table-layout: fixed;\n"
"  width: 40%;\n"
"  border-collapse: collapse;\n"
"  border: 2px solid purple;\n"
"}\n"
"\n"
"thead th:nth-child(1) {\n"
"  width: 10%;\n"
"}\n"
"\n"
"thead th:nth-child(2) {\n"
"  width: 70%;\n"
"}\n"
"\n"
"thead th:nth-child(3) {\n"
"  width: 20%;\n"
"}\n"
"\n"
"th, td {\n"
"  padding: 5px;\n"
"}\n"
"\n"
"tbody td {\n"
"  text-align: center;\n"
"}\n"
"\n"
"thead td {\n"
"	text-align: center;\n"
"}\n"
"\n"
"table td, table th {\n"
"	white-space: pre-wrap;\n"
"	border: 1px solid black;\n"
"}\n"
"\n"
"#overlay {\n"
"  position: fixed;\n"
"  display: none;\n"
"  width: 100%;\n"
"  height: 100%;\n"
"  top: 0;\n"
"  left: 0;\n"
"  right: 0;\n"
"  bottom: 0;\n"
"  background-color: rgba(0,0,0,0.5);\n"
"  z-index: 2;\n"
"  cursor: pointer;\n"
"}\n"
"\n"
"#text{\n"
"  position: absolute;\n"
"  top: 50%;\n"
"  left: 50%;\n"
"  font-size: 20px;\n"
"  color: white;\n"
"  transform: translate(-50%,-50%);\n"
"  -ms-transform: translate(-50%,-50%);\n"
"}\n"
"</style>\n"
"\n"
"<script>\n"
"var Game = {\n"
"	stopMain: {},\n"
"	sessionId: -1,\n"
"	playerId: -1,\n"
"	playerIndex: 0,\n"
"	globalpop: false,\n"
"	pop: \"\",\n"
"	host: \"\",\n"
"	startpost: true,\n"
"	keys: {},\n"
"	frames: {},\n"
"	numframes: 0,\n"
"	lastTick: 0,\n"
"	lastRender: 0,\n"
"\n"
"	maxposttimes: 100,\n"
"	posttimes: [100],\n"
"	numposttimes: 0,\n"
"	postindex: 0,\n"
"	postfull: false,\n"
"};\n"
"\n"
"function removeControlsOverlay() {\n"
"	document.getElementById(\"overlay\").style.display = \"none\";\n"
"};\n"
"\n"
"function showControlsOverlay() {\n"
"	document.getElementById(\"overlay\").style.display = \"block\";\n"
"}\n"
"\n"
"function AddPostTime(time) {\n"
"	if (!Game.postfull) {\n"
"		Game.numposttimes++;\n"
"	}\n"
"	if (Game.numposttimes == Game.maxposttimes) {\n"
"		Game.postfull = true;\n"
"	}\n"
"	Game.postindex = (Game.postindex + 1) % Game.numposttimes;\n"
"	Game.posttimes[Game.postindex] = time;\n"
"}\n"
"\n"
"function GetAveragePostTime() {\n"
"	var total = 0;\n"
"	for (i=0;i<Game.numposttimes;++i) {\n"
"		total += Game.posttimes[i];\n"
"	}\n"
"	return total / Game.numposttimes;\n"
"}\n"
"\n"
"function GeneratePostBody() {\n"
"	var numevents = Object.keys(Game.keys).length;\n"
"	var body = new ArrayBuffer(13 + numevents + 4);\n"
"	var view = new DataView(body);\n"
"	view.setUint32(0,Game.sessionId);\n"
"	view.setUint8(4,Game.globalpop);\n"
"\n"
"	view.setUint32(5, Game.playerIndex);\n"
"	view.setUint32(9, numevents);\n"
"	var index=0;\n"
"	for (var key in Game.keys) {\n"
"		view.setUint8(13+index,key);\n"
"		index++;\n"
"	}\n"
"	var num_requested_frames = 1; // adaptive frame interpolation isn't helping a lot yet.\n"
"	view.setUint32(13+index,num_requested_frames);\n"
"\n"
"	return body;\n"
"}\n"
"\n"
"// helper in case we need to download data for inspection\n"
"function download(filename, data) {\n"
"    var element = document.createElement('a');\n"
"    element.setAttribute('href', 'data:binary/octet-stream,' + data);\n"
"    element.setAttribute('download', filename);\n"
"\n"
"    element.style.display = 'none';\n"
"    document.body.appendChild(element);\n"
"\n"
"    element.click();\n"
"\n"
"    document.body.removeChild(element);\n"
"}\n"
"\n"
"document.addEventListener('keydown', (event) => {\n"
"  Game.keys[event.keyCode] = 1;\n"
"}, false);\n"
"\n"
"document.addEventListener('keyup', (event) => {\n"
"	delete Game.keys[event.keyCode];\n"
"}, false);\n"
"\n"
"function RenderFrame() {\n"
"	const rawcanvas = document.getElementById('framebuffer');\n"
"	rawcanvas.width = 960;\n"
"	rawcanvas.height = 600;\n"
"	const ctx = rawcanvas.getContext('2d');\n"
"\n"
"	var imageData = ctx.getImageData(0, 0, 100, 100);\n"
"	var data = new Uint8ClampedArray(4 * 320 * 200);\n"
"\n"
"	var palette = new Uint8ClampedArray(256*3);\n"
"	for (var i = 0; i < 256 * 3; ++i) {\n"
"		palette[i] = Game.frames[0][i];\n"
"	}\n"
"	//for (var i = 256*3; i < fb.length; i += 4) {\n"
"	fb_index = 256*3;\n"
"	for (var i = 0; i < data.length; i += 4) {\n"
"		data[i] = palette[Game.frames[0][fb_index]*3];\n"
"		data[i+1] = palette[Game.frames[0][fb_index]*3+1];\n"
"		data[i+2] = palette[Game.frames[0][fb_index]*3+2];\n"
"		data[i+3] = 255;\n"
"		fb_index++;\n"
"	}\n"
"\n"
"	var imageData = new ImageData(data, 320,200);\n"
"	tempcanvas = document.createElement('canvas');\n"
"	tempcanvas.width=320;\n"
"	tempcanvas.height=200;\n"
"	var tempctx = tempcanvas.getContext('2d');\n"
"	tempctx.putImageData(imageData,0,0);\n"
"\n"
"	ctx.scale(3,3);\n"
"	ctx.drawImage(tempcanvas,0,0);\n"
"	Game.lastRender = performance.now();\n"
"}\n"
"\n"
"function GetFrame() {\n"
"	var xhttp = new XMLHttpRequest();\n"
"	var startpost = performance.now();\n"
"	xhttp.onload = function(oEvent) {\n"
"		var posttime = performance.now() - startpost;\n"
"		AddPostTime(posttime);\n"
"		var arraybuffer = xhttp.response;\n"
"		if (arraybuffer) {\n"
"			var byteArray = new Uint8Array(arraybuffer);\n"
"			var dv = new DataView(arraybuffer);\n"
"\n"
"			let num_frames = dv.getInt32(0, true); // number of frames\n"
"			let frame_len = 320*200 + 768;\n"
"\n"
"			for (i=0;i<num_frames;++i) {\n"
"				let fb = new Uint8Array(arraybuffer.slice(4+i*frame_len));\n"
"				Game.frames[i] = fb;\n"
"			}\n"
"\n"
"			Game.numframes = num_frames;\n"
"\n"
"			Game.sessionId = dv.getInt32(4+num_frames*frame_len,true);\n"
"\n"
"			var poplen = dv.getInt32(8+num_frames*frame_len,true);\n"
"			var poparray = new Uint8Array(arraybuffer.slice(12+num_frames*frame_len,12+num_frames*frame_len+poplen));\n"
"			var pop = new TextDecoder(\"utf-8\").decode(poparray);\n"
"			if (Game.pop != pop) {\n"
"				Game.pop = pop;\n"
"				var pop_update = new XMLHttpRequest();\n"
"				pop_update.onload = function(oEvent) {\n"
"					refresh_sessions();\n"
"				}\n"
"				pop_update.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/update_pop_in_session\", true);\n"
"				pop_update.setRequestHeader(\"playerid\",Game.playerId);\n"
"				pop_update.setRequestHeader(\"sessionid\",Game.sessionId);\n"
"				pop_update.setRequestHeader(\"pop\",Game.pop);\n"
"				pop_update.send();\n"
"			}\n"
"\n"
"			var hostlen = dv.getInt32(12+num_frames*frame_len + poplen,true);\n"
"			var hostarray = new Uint8Array(arraybuffer.slice(16+num_frames*frame_len + poplen,16+num_frames*frame_len + poplen + hostlen));\n"
"			Game.host = new TextDecoder(\"utf-8\").decode(hostarray);\n"
"\n"
"			Game.startpost = true;\n"
"		}\n"
"	};\n"
"	xhttp.open(\"POST\", \"https://especially-cunning-bat.edgecompute.app/doomframe\", true);\n"
"	xhttp.responseType = \"arraybuffer\";\n"
"	var body = GeneratePostBody();\n"
"    xhttp.send(body);\n"
"}\n"
"\n"
"function refresh_sessions() {\n"
"	var session_req = new XMLHttpRequest();\n"
"	session_req.onload = function(oEvent) {\n"
"		var sessions = JSON.parse(session_req.response);\n"
"		var table = document.getElementById(\"sessions_table\");\n"
"\n"
"		var head = table.createTHead();\n"
"		let row = head.insertRow();\n"
"		let th = document.createElement(\"th\");\n"
"		let text = document.createTextNode(\"ID\");\n"
"		th.appendChild(text);\n"
"		row.appendChild(th);\n"
"		th = document.createElement(\"th\");\n"
"		text = document.createTextNode(\"Players\");\n"
"		th.appendChild(text);\n"
"		row.appendChild(th);\n"
"		th = document.createElement(\"th\");\n"
"		text = document.createTextNode(\"Join\");\n"
"		th.appendChild(text);\n"
"		row.appendChild(th);\n"
"\n"
"	for(var i = table.rows.length; i > 1;i--)\n"
"		{\n"
"			document.getElementById(\"sessions_table\").deleteRow(i -1);\n"
"		}\n"
"		sessions.forEach(session => {\n"
"			var row = table.insertRow(-1);\n"
"			var idcell = row.insertCell(0);\n"
"			var playercell = row.insertCell(1);\n"
"			var buttoncell = row.insertCell(2);\n"
"			idcell.innerHTML = session.id;\n"
"			session.players.forEach(player => {\n"
"				if (player.id == Game.playerId) {\n"
"					playercell.innerHTML += \"<b>\" + player.name + \" (me)</b>\";\n"
"				} else {\n"
"					playercell.innerHTML += player.name;\n"
"				}\n"
"				if (Game.pop != \"\") {\n"
"					playercell.innerHTML += \" (\" + Game.pop + \")\\n\";\n"
"				} else {\n"
"					playercell.innerHTML += \"\\n\";\n"
"				}\n"
"			});\n"
"			buttoncell.innerHTML = \"<button id=\"+session.id+\" onClick=join_session(this.id);>Join</button>\"\n"
"		});\n"
"	}\n"
"\n"
"	session_req.open(\"GET\", \"https://loudly-verified-elephant.edgecompute.app/sessions\", true);\n"
"	session_req.send();\n"
"}\n"
"\n"
"function join_session(id) {\n"
"	xhttp.open(\"GET\", \"https://loudly-verified-elephant.edgecompute.app/join_session\", true);\n"
"		xhttp.responseType = \"text\";\n"
"		xhttp.setRequestHeader(\"playerid\",Game.playerId);\n"
"		xhttp.setRequestHeader(\"name\",document.getElementById(\"player_name\").value);\n"
"		xhttp.setRequestHeader(\"sessionid\",id);\n"
"		xhttp.send();\n"
"}\n"
"\n"
"\n"
";(function () {\n"
"	function main( tFrame ) {\n"
"		Game.stopMain = window.requestAnimationFrame( main );\n"
"		var delta = tFrame-Game.lastTick;\n"
"		Game.lastTick = tFrame;\n"
"\n"
"		if (Game.numframes > 0)\n"
"			RenderFrame();\n"
"\n"
"		if (Game.startpost)\n"
"		{\n"
"			GetFrame();\n"
"			Game.startpost = false;\n"
"		}\n"
"	}\n"
"\n"
"	function get_value_from_cookie(key) {\n"
"		var value;\n"
"		var row = document.cookie\n"
"			.split('; ')\n"
"			.find(row => row.startsWith(key));\n"
"			if (typeof row != \"undefined\") {\n"
"				value = row.split('=')[1];\n"
"			} else {\n"
"				value = \"\";\n"
"			}\n"
"		return value;\n"
"	}\n"
"\n"
"	function update_name_in_session()\n"
"	{\n"
"		var xhttp = new XMLHttpRequest();\n"
"		xhttp.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/update_name_in_session\", true);\n"
"		xhttp.setRequestHeader(\"sessionid\",Game.sessionId);\n"
"		xhttp.setRequestHeader(\"playerid\",Game.playerId);\n"
"		xhttp.setRequestHeader(\"name\",document.getElementById(\"player_name\").value);\n"
"		xhttp.send();\n"
"	}\n"
"\n"
"	function lobby_heartbeat() {\n"
"		var heartbeat_req = new XMLHttpRequest();\n"
"		heartbeat_req.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/heartbeat\", true);\n"
"		heartbeat_req.responseType = \"text\";\n"
"		heartbeat_req.setRequestHeader(\"sessionid\",Game.sessionId);\n"
"		heartbeat_req.setRequestHeader(\"playerid\",Game.playerId);\n"
"		heartbeat_req.send();\n"
"		refresh_sessions();\n"
"	}\n"
"\n"
"	function init_user() {\n"
"		var playerid=get_value_from_cookie('playerid');\n"
"		var playername = get_value_from_cookie('playername');\n"
"\n"
"		if (playerid == 0) {\n"
"			playerid = Math.floor(Math.random() * 100000);\n"
"			document.cookie = \"playerid=\"+playerid;\n"
"			playername=\"Player\" + playerid;\n"
"			document.cookie = \"playername=\"+playername;\n"
"		}\n"
"		Game.playerId = playerid;\n"
"		if (playername == \"\") {\n"
"			playername=\"Player\" + playerid;\n"
"			document.cookie = \"playername=\"+playername;\n"
"		}\n"
"		document.getElementById(\"player_name\").value = playername;\n"
"\n"
"		document.getElementById(\"player_name\").onchange = function() {\n"
"			document.cookie = \"playername=\"+document.getElementById(\"player_name\").value;\n"
"			update_name_in_session();\n"
"		}\n"
"		setInterval(lobby_heartbeat, 1000 * 30); // 30s interval\n"
"	}\n"
"\n"
"	function join_best_session() {\n"
"		var xhttp = new XMLHttpRequest();\n"
"		xhttp.onload = function(oEvent) {\n"
"			var parts = xhttp.response.split(',');\n"
"			Game.sessionId = parts[0];\n"
"//			document.getElementById('player_index').value = parts[1];\n"
"			Game.playerIndex = parts[1];\n"
"			Game.playerIndex = parts[1];\n"
"			Game.lastTick = performance.now();\n"
"			main(performance.now());\n"
"		};\n"
"		xhttp.open(\"GET\", \"https://loudly-verified-elephant.edgecompute.app/join_best_session\", true);\n"
"		xhttp.responseType = \"text\";\n"
"		xhttp.setRequestHeader(\"id\",Game.playerId);\n"
"		xhttp.setRequestHeader(\"name\",document.getElementById(\"player_name\").value);\n"
"		xhttp.send();\n"
"	}\n"
"\n"
"	init_user();\n"
"	join_best_session();\n"
"	refresh_sessions();\n"
"})();\n"
"</script>\n"
"</html\n"
