"<html>\n"
"\n"
"<canvas id=\"framebuffer\"></canvas>\n"
"\n"
"<style>\n"
"div {\n"
"    white-space: pre-wrap;\n"
"}\n"
"</style>\n"
"\n"
"<div>\n"
"W to move forward\n"
"S to move backward\n"
"A to turn left\n"
"D to turn right\n"
"Q to strafe left\n"
"E to strafe right\n"
"F to fire\n"
"U to use\n"
"</div>\n"
"\n"
"<p id=\"profiling\"></p>\n"
"\n"
"<script>\n"
"var Game = {\n"
"	stopMain: {},\n"
"	curState: {},\n"
"	startpost: true,\n"
"	keys: {},\n"
"	frames: {},\n"
"	numframes: 0,\n"
"	frameIndex: 0,\n"
"	lastTick: 0,\n"
"	lastRender: 0,\n"
"\n"
"	maxposttimes: 100,\n"
"	posttimes: [100],\n"
"	numposttimes: 0,\n"
"	postindex: 0,\n"
"	postfull: false,\n"
"};\n"
"\n"
"function AddPostTime(time) {\n"
"	if (!Game.postfull) {\n"
"		Game.numposttimes++;\n"
"	}\n"
"	if (Game.numposttimes == Game.maxposttimes) {\n"
"		Game.postfull = true;\n"
"	}\n"
"	Game.postindex = (Game.postindex + 1) % Game.numposttimes;\n"
"	Game.posttimes[Game.postindex] = time;\n"
"}\n"
"\n"
"function GetAveragePostTime() {\n"
"	var total = 0;\n"
"	for (i=0;i<Game.numposttimes;++i) {\n"
"		total += Game.posttimes[i];\n"
"	}\n"
"	return total / Game.numposttimes;\n"
"}\n"
"\n"
"// typedef struct\n"
"// {\n"
"//     char	forwardmove;	// *2048 for move\n"
"//     char	sidemove;	// *2048 for move\n"
"//     short	angleturn;	// <<16 for angle delta\n"
"//     short	consistancy;	// checks for net game\n"
"//     byte	chatchar;\n"
"//     byte	buttons;\n"
"// } ticcmd_t;\n"
"\n"
"function GeneratePostBody() {\n"
"	if (!Game.curState.byteLength) {\n"
"		return;\n"
"	}\n"
"	var numevents = Object.keys(Game.keys).length;\n"
"	var body = new ArrayBuffer(4 + Game.curState.byteLength + 4 + numevents + 4);\n"
"	var view = new DataView(body);\n"
"	view.setUint32(0,Game.curState.byteLength);\n"
"\n"
"	// I'm sure there's a better way to do this.\n"
"	for (i=0;i<Game.curState.byteLength;++i) {\n"
"		view.setUint8(i+4, Game.curState[i]);\n"
"	}\n"
"\n"
"	view.setUint32(Game.curState.byteLength + 4, numevents);\n"
"	let base = 8 + Game.curState.byteLength;\n"
"	var index=0;\n"
"	for (var key in Game.keys) {\n"
"		view.setUint8(base+index,key);\n"
"		index++;\n"
"	}\n"
"//	var num_requested_frames = GetAveragePostTime() / 50;\n"
"	var num_requested_frames = 1; // adaptive frame interpolation isn't helping a lot yet.\n"
"	view.setUint32(base+index,num_requested_frames); \n"
"\n"
"	return body;\n"
"}\n"
"\n"
"// helper in case we need to download data for inspection\n"
"function download(filename, data) {\n"
"    var element = document.createElement('a');\n"
"    element.setAttribute('href', 'data:binary/octet-stream,' + data);\n"
"    element.setAttribute('download', filename);\n"
"\n"
"    element.style.display = 'none';\n"
"    document.body.appendChild(element);\n"
"\n"
"    element.click();\n"
"\n"
"    document.body.removeChild(element);\n"
"}\n"
"\n"
"document.addEventListener('keydown', (event) => {\n"
"  Game.keys[event.keyCode] = 1;\n"
"}, false);\n"
"\n"
"document.addEventListener('keyup', (event) => {\n"
"	delete Game.keys[event.keyCode];\n"
"}, false);\n"
"\n"
"function RenderFrame(index) {\n"
"	index = 0;\n"
"	const rawcanvas = document.getElementById('framebuffer');\n"
"	rawcanvas.width = 960;\n"
"	rawcanvas.height = 600;\n"
"	const ctx = rawcanvas.getContext('2d');\n"
"\n"
"	var imageData = ctx.getImageData(0, 0, 100, 100);\n"
"	var data = new Uint8ClampedArray(4 * 320 * 200);\n"
"\n"
"	var palette = new Uint8ClampedArray(256*3);\n"
"	for (var i = 0; i < 256 * 3; ++i) {\n"
"		palette[i] = Game.frames[index][i];\n"
"	}\n"
"	//for (var i = 256*3; i < fb.length; i += 4) {\n"
"	fb_index = 256*3;\n"
"	for (var i = 0; i < data.length; i += 4) {\n"
"		data[i] = palette[Game.frames[index][fb_index]*3];\n"
"		data[i+1] = palette[Game.frames[index][fb_index]*3+1];\n"
"		data[i+2] = palette[Game.frames[index][fb_index]*3+2];\n"
"		data[i+3] = 255;\n"
"		fb_index++;\n"
"	}\n"
"\n"
"	var imageData = new ImageData(data, 320,200);\n"
"	tempcanvas = document.createElement('canvas');\n"
"	tempcanvas.width=320;\n"
"	tempcanvas.height=200;\n"
"	var tempctx = tempcanvas.getContext('2d');\n"
"	tempctx.putImageData(imageData,0,0);\n"
"\n"
"	ctx.scale(3,3);\n"
"	ctx.drawImage(tempcanvas,0,0);\n"
"	Game.lastRender = performance.now();\n"
"}\n"
"\n"
"function GetFrame() {\n"
"	var xhttp = new XMLHttpRequest();\n"
"	var startpost = performance.now();\n"
"	xhttp.onload = function(oEvent) {\n"
"		var posttime = performance.now() - startpost;\n"
"		AddPostTime(posttime);\n"
"		var arraybuffer = xhttp.response;\n"
"		if (arraybuffer) {\n"
"			var byteArray = new Uint8Array(arraybuffer);\n"
"			var dv = new DataView(arraybuffer);\n"
"\n"
"			let num_frames = dv.getInt32(0, true); // number of frames\n"
"			let frame_len = 320*200 + 768;\n"
"\n"
"			for (i=0;i<num_frames;++i) {\n"
"				let fb = new Uint8Array(arraybuffer.slice(4+i*frame_len));\n"
"				Game.frames[i] = fb;\n"
"			}\n"
"\n"
"			Game.numframes = num_frames;\n"
"			Game.frameIndex = 0;\n"
"\n"
"			let gs_len = dv.getInt32(4+num_frames*frame_len,true);\n"
"			Game.curState = new Uint8Array(arraybuffer.slice(8+num_frames*frame_len));\n"
"			Game.startpost = true;\n"
"		}\n"
"	};\n"
"	// Access-Control-Allow-Origin	\n"
"	xhttp.open(\"POST\", \"https://definitely-shining-penguin.edgecompute.app/zipdoomframe\", true);\n"
"	xhttp.responseType = \"arraybuffer\";\n"
"	var body = GeneratePostBody();\n"
"    xhttp.send(body);\n"
"}\n"
"\n"
";(function () {\n"
"	function main( tFrame ) {\n"
"	Game.stopMain = window.requestAnimationFrame( main );\n"
"	var delta = tFrame-Game.lastTick;\n"
"	Game.lastTick = tFrame;\n"
"\n"
"	if (Game.numframes > 0) {\n"
"		if (performance.now() - Game.lastRender > GetAveragePostTime() / Game.numframes) {\n"
"			// var frametime = performance.now() - Game.lastRender;\n"
"			// document.getElementById('profiling').innerHTML = \"Frametime: \" + frametime;\n"
"			RenderFrame(Game.frameIndex);\n"
"			if (Game.frameIndex < Game.numframes-1)\n"
"				Game.frameIndex++;\n"
"		}\n"
"	}\n"
"\n"
"	if (Game.startpost)\n"
"	{\n"
"		GetFrame();\n"
"		Game.startpost = false;\n"
"	}\n"
"}\n"
"\n"
"	Game.lastTick = performance.now();\n"
"	main(performance.now());\n"
"})();\n"
"</script>\n"
"</html\n"
